from flask import Blueprint, request, render_template, flash, g, session, redirect, url_for, \
                  abort, jsonify

import sys
from os import path
current_dir = path.dirname(__file__)
sys.path.insert(0, path.join(current_dir,'../../../recon/autorecon/'))

from modules.subdomains import subdomains
import re
from urllib.parse import urlparse
import validators
from threading import Thread

mod = Blueprint('autorecon', __name__)

@mod.route('/autorecon/')
def index():
  return (render_template('autorecon/index.html'))

@mod.route('/autorecon/scan', methods=['POST'])
def start_scan():

  try:
    domain = request.form['domain']
    name = request.form['name']
  except IndexError:
    return 'Invalid parameters', 403
  if not validators.domain(domain) or not re.match(r'^[a-zA-Z0-9]+$', name):
    return 'Invalid domain', 403
  output_directory = path.join(current_dir, '../static/reports/', name)
  Thread(target=subdomains, args=[[domain], output_directory]).start()
  return render_template('autorecon/index.html', alert='The scan has started')